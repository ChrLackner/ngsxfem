stages:
    - build
    - test
    - deploy
        
build:
  stage: build
  image: ngsxfem/ngsolve:latest
  script:
    - python3 -c "import ngsolve"
    - git config --global --add safe.directory /builds/lehrenfeld/ngsxfem
    - git config --global --add safe.directory /builds/lehrenfeld/ngsxfem/external_dependencies/jupyter
    - git config --global --add safe.directory /builds/lehrenfeld/ngsxfem/external_dependencies/ngsolve
    - git submodule
    - git submodule update --init
    - mkdir build
    - mkdir install    
    - cd build
    - cmake -DBUILD_NGSOLVE=OFF -DCHECK_NGSOLVE_VERSION=OFF -DCMAKE_INSTALL_PREFIX=../install ..
    - make install
  artifacts:
    paths:
      - build
      - install
        
pages:
  stage: deploy
  image: ngsxfem/ngsolve:latest
  script:
    - pip3 install --user -r ./doc/sphinx/requirements.txt
    - sphinx-apidoc -e -f -o doc/sphinx/xfem_doc install/lib/python3.10/site-packages/xfem/
    - sphinx-build doc/sphinx html
    - mv html public
  artifacts:
    paths:
      - public
  only:
    - sphinx # this job will affect only the 'sphinx' branch

