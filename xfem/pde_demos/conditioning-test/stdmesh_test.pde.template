
# load geometry
geometry = square.in2d

# and mesh
#mesh = square.vol.gz
#mesh = square_trigs_2x2.vol.gz
mesh = square_trigs_med.vol
#mesh = square_quad_coarse.vol.gz

shared = libngsxfem_xfem

define constant heapsize = 1e8

define constant zero = 0.0
define constant one = 1.0
define constant two = 2.0

define constant x0 = (var/1e6)
define constant y0 = 0.5

define constant bneg = 1.0
define constant bpos = 1.0

define constant aneg = (ANEG/1024)
define constant apos = 1.0 # (ANEG/1024)

define constant abneg = (aneg*bneg)
define constant abpos = (apos*bpos)

define coefficient f
(sin(x+y)),

define coefficient df
(cos(x+y)),

define coefficient mddf
(2*sin(x+y)),

define coefficient rhspos
(bpos*apos*2*sin(x+y)),

define coefficient rhsneg
(bneg*aneg*2*sin(x+y)),

define coefficient solpos
(sin(x+y)),

define coefficient solposx
(cos(x+y)),

define coefficient solposy
(cos(x+y)),

define coefficient solneg
((bpos)/(bneg)*(sin(x+y))),

define coefficient solnegx
((bpos)/(bneg)*cos(x+y)),

define coefficient solnegy
((bpos)/(bneg)*cos(x+y)),

define constant lambda = setlam

define constant R = 0.2


define coefficient lset
((x-x0)*(x-x0)+(y-y0)*(y-y0)-R*R),       

define fespace fescomp
       -type=xh1fespace
       -order=1
       -dirichlet=[1,2]
#       -dgjumps

numproc informxfem npix 
        -xh1fespace=fescomp
        -coef_levelset=lset

define gridfunction u -fespace=fescomp

#numproc shapetester npst -gridfunction=u

define bilinearform a -fespace=fescomp # -printelmat -print
#xmass one one
xlaplace abneg abpos
xnitsche_hansbo aneg apos bneg bpos lambda
#xnitsche_minstab_alpha aneg apos bneg bpos
#xnitsche_minstab_halfhalf aneg apos bneg bpos
#xnitsche_minstab_hansbo aneg apos bneg bpos
#lo_ghostpenalty aneg apos one

define linearform f -fespace=fescomp # -print
#xsource solneg solpos
xsource rhsneg rhspos
#xneumann bneg_bndvalneg_pen bpos_bndvalpos_pen

#numproc setvalues npsv -gridfunction=u.1 -coefficient=zero -boundary

numproc setvaluesx npsvx -gridfunction=u -coefficient_neg=solneg -coefficient_pos=solpos -boundary #-print

define preconditioner c1 -type=bddc -bilinearform=a -test
define preconditioner c2 -type=bddc -bilinearform=a -test -block
define preconditioner c3 -type=local -bilinearform=a -test -block
define preconditioner c4 -type=local -bilinearform=a -test

#define preconditioner c -type=direct -bilinearform=a -test

numproc bvp npbvp -gridfunction=u -bilinearform=a -linearform=f -solver=cg -preconditioner=c1 -maxsteps=1000 -prec=1e-6 # -print

numproc setvaluesx npsvx -gridfunction=u -coefficient_neg=solneg -coefficient_pos=solpos -boundary -print

numproc bvp npbvp2 -gridfunction=u -bilinearform=a -linearform=f -solver=cg -preconditioner=c2 -maxsteps=1000 -prec=1e-6 # -print

numproc setvaluesx npsvx -gridfunction=u -coefficient_neg=solneg -coefficient_pos=solpos -boundary -print

numproc bvp npbvp3 -gridfunction=u -bilinearform=a -linearform=f -solver=cg -preconditioner=c3 -maxsteps=1000 -prec=1e-6 # -print

numproc setvaluesx npsvx -gridfunction=u -coefficient_neg=solneg -coefficient_pos=solpos -boundary -print

numproc bvp npbvp4 -gridfunction=u -bilinearform=a -linearform=f -solver=cg -preconditioner=c4 -maxsteps=1000 -prec=1e-6 # -print

define coefficient veczero
(0,0),

numproc calccond npcc -bilinearform=a -symmetric -inverse=pardiso

numproc xdifference npxd 
        -solution=u 
        -solution_n=solneg
        -solution_p=solpos
        -levelset=lset
        -interorder=2
        -henryweight_n=(bneg)
        -henryweight_p=(bpos)

numproc visualization npviz -scalarfunction=u
